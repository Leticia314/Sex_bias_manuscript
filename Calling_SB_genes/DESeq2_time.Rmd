---
title: "DESeq2_time"
author: "Leticia"
date: "18/01/2022"
output:
  html_document: 
    toc: true
    toc_depth: 4
---
## Aim

Using the DESeq2 package to detect developmental sex-biased genes.

## Libraries and functions

```{r, message=FALSE, warning=FALSE}
library(DESeq2)
library(gplots)
library(readr)
library(dplyr)

#Function for preparing data for DESEq2. sp= species; ts= tissue.
prepro_data_DESeq2 <- function(species, tissues){
  # Loading counts and metadata from the species
  metadata_sp<- read_csv(paste0("../metadata/", species, ".sampleTable.csv"))
  counts_sp <- as.matrix(read.table(gzfile(paste0("~/R_analyses/260421_DESeq2/counts/", species, "_counts_alltp.txt.gz")),header = TRUE))
  
  # Splitting metadata and counts by organ and storing in lists
  sp_meta<-list()
  sp_counts <-list()
  for (ts in 1:length(tissues)){
    meta_ts <- subset(metadata_sp, tissue==tissues[ts])
    
    #Filtering time points where we don't have males or females and adding numbers to the replicates
    meta_ts %>% group_by(timePoint) %>% summarise(femCount = sum(sex == "Female"), maleCount = sum(sex == "Male"))%>% filter(femCount != 0 & maleCount != 0)%>% dplyr::select(timePoint)->tps
    meta_ts_filt <- subset(meta_ts, timePoint %in% tps$timePoint)
    
    counts_ts <-counts_sp[,as.character(meta_ts_filt$id)]
    
    # Filtering out genes that are expressed in less than 3 samples
    filt_genes <- read.table(paste0("filtered_genes/280222_", species, "_", tissues[ts], ".txt"))
    counts_ts_filt <- counts_ts[(rownames(counts_ts) %in% filt_genes$V2), ]
    
    sp_meta[[ts]]<-meta_ts_filt
    sp_counts[[ts]] <-counts_ts_filt
  }
  names(sp_meta)<- paste0(species,"_", tissues)
  names(sp_counts)<- paste0(species,"_", tissues)
  return(list(sp_meta, sp_counts))
}

#Function for performing differential expression analysis and likelihod ratio test. counts_ts= preprocessed counts for 1 species and 1 tissue; meta_ts= preprocessed metadata for 1 species and 1 tissue.
DESeq_calls <- function(counts_ts, meta_ts){
  # Making sure that the columns in the count matrix are in the right order
  rownames(meta_ts) <- as.character(meta_ts$id)
  counts_ts <- counts_ts[, rownames(meta_ts)]
  
  # Setting time points to start in 0
  tp_table <- as.data.frame(table(meta_ts$timePoint))
  meta_ts$new_timePoint <- rep(0:(nrow(tp_table)-1), tp_table$Freq)
  
  # Creating the matrix with our factors of interest (sex and time)
  designMatrix <- data.frame(sex=meta_ts$sex,time=meta_ts$new_timePoint)
  
  # Constructing the DESeqDataSet
  dds <- DESeqDataSetFromMatrix(countData = counts_ts, colData = designMatrix, design = ~sex + time + sex:time)
  
  # Performing the main computation
  dds <- DESeq(dds)
  
  # Likelihood ratio test
  ddsLRT <- nbinomLRT(dds, reduced = ~time)
  resLRT <- as.data.frame(results(ddsLRT))
  
  return(resLRT)
}
```

## Running pipeline

```{r, message=FALSE, warning=FALSE}
species <- c( "Human", "Mouse", "Rat", "Rabbit", "Opossum", "Chicken")
tissues <- c("Brain", "Cerebellum", "Heart", "Kidney", "Liver")

results <- list()

for (sp in species){
  sp_meta_ts <-prepro_data_DESeq2(sp, tissues)[[1]]
  sp_counts_ts<-prepro_data_DESeq2(sp, tissues)[[2]]
  for (ts in tissues){
    DESeq_res <- DESeq_calls(sp_counts_ts[[paste0(sp, "_", ts)]], sp_meta_ts[[paste0(sp, "_", ts)]])
    results[[paste0(sp, "_", ts)]] <- DESeq_res

    # Exporting results
    write.table(DESeq_res, sep="\t", file=paste0("DESeq_res/", sp, "_", ts, ".txt"), quote=FALSE)
  }
}
```

